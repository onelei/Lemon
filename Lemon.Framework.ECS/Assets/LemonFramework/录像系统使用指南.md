# 📹 ECS录像系统使用指南

## 概述

这是一个功能完整的ECS录像系统，支持游戏过程的录制、保存、播放和精确控制。

## 核心功能

### ✅ 已实现功能

1. **录制录像** - 实时录制游戏每一帧的状态
2. **保存/加载** - 将录像保存到文件或从文件加载
3. **播放控制** - 播放、暂停、停止
4. **帧精确跳转** - 快速跳转到任意帧
5. **变速播放** - 0.25x, 0.5x, 1x, 2x, 4x, 8x 倍速
6. **进度控制** - 可拖动进度条直接跳转
7. **逐帧播放** - 支持前进/后退单帧

## 快速开始

### 1. 在Unity中使用Demo

1. 打开场景 `LemonFramework/Demo/Scenes/SampleScene.unity`
2. 在Hierarchy中创建一个空GameObject
3. 添加 `ReplayDemo` 组件
4. 设置参数：
   - `Entity Count`: 要创建的实体数量（建议5-10个）
   - `Entity Prefab`: 实体预制体（可留空，会自动创建立方体）
   - `Replay File Name`: 录像文件名（默认：gameplay_replay.dat）

### 2. 运行Demo

点击Unity的播放按钮运行Demo。

### 3. 操作说明

#### 基本控制
- **WASD** - 控制红色立方体移动

#### 录制操作
1. 点击"开始录制"按钮
2. 操作红色立方体进行移动
3. 点击"停止录制"完成录制
4. 点击"保存录像"将录像保存到文件

#### 播放操作
1. 点击"加载录像"从文件加载之前保存的录像
2. 点击"播放"开始播放
3. 点击"暂停"可以暂停播放
4. 点击"停止"停止并回到开始

#### 播放速度控制
- 点击速度按钮（0.25x, 0.5x, 1x, 2x, 4x, 8x）改变播放速度
- 1x 是正常速度

#### 帧控制
- **◄ 上一帧** - 后退一帧
- **下一帧 ►** - 前进一帧
- **◄◄ 前10帧** - 快速后退10帧
- **后10帧 ►►** - 快速前进10帧

#### 进度控制
- 拖动底部的进度条可以直接跳转到任意位置

## 代码集成

### 在你自己的项目中使用

#### 1. 初始化录像系统

```csharp
using LemonFramework.ECS.Replay;

// 创建ECS World
World world = new World("MyWorld");

// 创建录像录制器和播放器
ReplayRecorder recorder = new ReplayRecorder(world);
ReplayPlayer player = new ReplayPlayer(world);
```

#### 2. 录制录像

```csharp
// 开始录制
recorder.StartRecording("我的录像", targetFrameRate: 60);

// 在每一帧调用（通常在Update或游戏循环中）
recorder.RecordFrame();

// 停止录制并获取录像数据
ReplayData replay = recorder.StopRecording();

// 保存到文件
recorder.SaveReplay("path/to/replay.dat");
```

#### 3. 播放录像

```csharp
// 从文件加载录像
player.LoadReplayFromFile("path/to/replay.dat");

// 或直接加载ReplayData对象
player.LoadReplay(replayData);

// 开始播放
player.Play();

// 在每一帧更新（通常在Update中）
player.Update(Time.deltaTime);

// 暂停/恢复
player.Pause();
player.Play();

// 停止播放
player.Stop();
```

#### 4. 控制播放

```csharp
// 设置播放速度
player.SetPlaybackSpeed(2.0f); // 2倍速

// 跳转到指定帧
player.SeekToFrame(frameNumber);

// 跳转到指定时间（秒）
player.SeekToTime(5.0f); // 跳转到第5秒

// 跳转到指定进度（0.0 - 1.0）
player.SeekToProgress(0.5f); // 跳转到50%位置

// 逐帧控制
player.StepForward();  // 下一帧
player.StepBackward(); // 上一帧

// 设置循环播放
player.Loop = true;
```

#### 5. 获取播放状态

```csharp
// 检查是否正在播放
bool isPlaying = player.IsPlaying;

// 获取当前帧号
int currentFrame = player.CurrentFrameNumber;

// 获取总帧数
int totalFrames = player.TotalFrames;

// 获取播放进度（0.0 - 1.0）
float progress = player.Progress;

// 获取当前时间和总时长
float currentTime = player.CurrentTime;
float totalDuration = player.TotalDuration;
```

## API参考

### ReplayData

录像数据类，存储所有帧的快照信息。

**属性：**
- `ReplayName` - 录像名称
- `StartFrame` - 开始帧号
- `EndFrame` - 结束帧号
- `TotalFrames` - 总帧数
- `TargetFrameRate` - 录制时的帧率
- `Duration` - 录像时长（秒）

**方法：**
- `AddFrame(snapshot)` - 添加一帧快照
- `GetFrame(frameNumber)` - 获取指定帧的快照
- `SaveToFile(filePath)` - 保存到文件
- `LoadFromFile(filePath)` - 从文件加载（静态方法）

### ReplayRecorder

录像录制器，负责录制功能。

**属性：**
- `IsRecording` - 是否正在录制
- `RecordedFrames` - 已录制的帧数

**方法：**
- `StartRecording(name, frameRate)` - 开始录制
- `StopRecording()` - 停止录制并返回录像数据
- `RecordFrame()` - 记录当前帧
- `CancelRecording()` - 取消录制
- `SaveReplay(filePath)` - 保存录像到文件

### ReplayPlayer

录像播放器，支持播放和各种控制功能。

**属性：**
- `IsPlaying` - 是否正在播放
- `PlaybackSpeed` - 播放速度倍数
- `Loop` - 是否循环播放
- `CurrentFrameIndex` - 当前帧索引
- `CurrentFrameNumber` - 当前帧号
- `TotalFrames` - 总帧数
- `Progress` - 播放进度（0.0-1.0）
- `CurrentTime` - 当前时间（秒）
- `TotalDuration` - 总时长（秒）

**方法：**
- `LoadReplay(replay)` - 加载录像数据
- `LoadReplayFromFile(filePath)` - 从文件加载
- `Play()` - 开始播放
- `Pause()` - 暂停播放
- `Stop()` - 停止播放
- `Update(deltaTime)` - 更新播放（每帧调用）
- `SeekToFrame(frameNumber)` - 跳转到指定帧号
- `SeekToFrameIndex(index)` - 跳转到指定帧索引
- `SeekToProgress(progress)` - 跳转到指定进度
- `SeekToTime(time)` - 跳转到指定时间
- `StepForward()` - 前进一帧
- `StepBackward()` - 后退一帧
- `SetPlaybackSpeed(speed)` - 设置播放速度

## 技术细节

### 录像文件格式

录像文件采用二进制格式，包含以下数据：

1. **元数据**
   - 录像名称
   - 创建时间
   - 开始/结束帧号
   - 目标帧率

2. **帧数据**
   - 每一帧的完整快照
   - 包含所有实体和组件数据

### 性能考虑

- **录制开销**：每帧创建一个快照，开销与实体数量和组件复杂度成正比
- **内存占用**：所有帧都保存在内存中，长时间录制会占用大量内存
- **文件大小**：文件大小取决于帧数和场景复杂度
- **播放性能**：播放时仅恢复快照，不执行系统逻辑，性能开销小

### 优化建议

1. **降低录制频率**：不必每帧都录制，可以每N帧录制一次
2. **限制录制时长**：设置最大帧数限制
3. **压缩数据**：对快照数据进行压缩（可扩展实现）
4. **增量快照**：只保存变化的数据（可扩展实现）

## 使用场景

1. **游戏回放**：观看游戏精彩瞬间
2. **调试工具**：重现bug场景，逐帧分析
3. **AI训练**：录制玩家操作作为训练数据
4. **教程系统**：制作教学录像
5. **竞技分析**：分析玩家操作和策略

## 常见问题

### Q: 录像文件很大怎么办？
A: 可以降低录制帧率，或者只录制关键帧。未来可以实现数据压缩。

### Q: 如何实现网络回放？
A: 将ReplayData序列化后通过网络传输，接收端反序列化后播放。

### Q: 播放时可以暂停并继续游戏吗？
A: 可以。从播放状态切换到录制状态，继续游戏并录制。

### Q: 支持快进/快退吗？
A: 支持。使用SeekToFrame系列方法或调整PlaybackSpeed。

### Q: 可以导出视频吗？
A: 录像系统本身不导出视频，但可以结合Unity的录屏工具在播放时录制视频。

## 扩展开发

### 添加自定义组件支持

确保你的组件实现了 `IComponentData` 和 `ISerializable` 接口：

```csharp
public struct MyComponent : IComponentData, ISerializable
{
    public float Value;
    
    public void Serialize(BinaryWriter writer)
    {
        writer.Write(Value);
    }
    
    public void Deserialize(BinaryReader reader)
    {
        Value = reader.ReadSingle();
    }
}

// 注册组件类型
ComponentManager.RegisterComponentType<MyComponent>();
```

### 添加事件系统

你可以扩展ReplayPlayer添加事件回调：

```csharp
public event Action OnPlaybackStarted;
public event Action OnPlaybackPaused;
public event Action OnPlaybackStopped;
public event Action<int> OnFrameChanged;
```

## 总结

这个录像系统提供了完整的录制和播放功能，易于集成到现有项目中。通过简单的API调用，你就可以为游戏添加强大的回放功能。

祝您使用愉快！🎮

